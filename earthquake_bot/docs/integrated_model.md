# Интегрированная модель прогнозирования землетрясений

## Обзор

Интегрированная модель (`main_integrated.py`) — это улучшенная версия базовой модели Пуассона для прогнозирования землетрясений. Она объединяет четыре компонента:

1. **Bayesian Poisson (Gamma-Poisson)** — учёт неопределённости в параметре λ
2. **ETAS-коррекция** — учёт кластеризации афтершоков
3. **Лунный модификатор** — учёт приливных сил
4. **Исторический fit** — параметры из реальных данных 1900-2024

## Сравнение моделей

| Аспект | Простая модель | Интегрированная модель |
|--------|----------------|------------------------|
| Распределение | Poisson(λ = 15) | Negative Binomial |
| λ | Фиксированное | Распределение Gamma |
| Неопределённость | Нет | Да (шире хвосты) |
| Кластеризация | Нет | ETAS (закон Омори) |
| Приливы | Нет | Лунные фазы ±7.5% |
| Исторические данные | Табличное значение | Fit на 124 года данных |

## Математические основы

### 1. Bayesian Poisson (Gamma-Poisson Conjugate)

**Проблема простой модели:**
Фиксированное λ = 15 не учитывает, что реальная частота M7.0+ варьируется от 7 до 23 в год.

**Решение:**
Моделируем λ как случайную величину с распределением Gamma:

```
Prior:     λ ~ Gamma(α, β)
Likelihood: X | λ ~ Poisson(λ)
Posterior: λ | X ~ Gamma(α + n, β + t)
```

где n — наблюдённое количество событий за t лет.

**Предиктивное распределение:**
```
X ~ NegativeBinomial(r = α_post, p = β_post / (β_post + t_future))
```

Negative Binomial имеет более тяжёлые хвосты, чем Poisson, что лучше отражает реальность.

**Параметры из данных (M7.0+, 1900-2024):**
```
Среднее:  μ = 14.5 событий/год
Дисперсия: σ² = 8.5
Std:      σ = 2.9
Min:      7 (2017)
Max:      23 (2010)

Gamma fit:
α = μ²/σ² ≈ 24.6
β = μ/σ² ≈ 1.7
```

### 2. ETAS-коррекция (Epidemic-Type Aftershock Sequence)

После крупного землетрясения вероятность следующего временно повышается из-за афтершоков.

**Закон Омори (затухание афтершоков):**
```
λ(t) = K / (t + c)^p
```

где:
- t — время после основного толчка (дни)
- c ≈ 0.01 (параметр сглаживания)
- p ≈ 1.1 (экспонента затухания)
- K — продуктивность

**Продуктивность (зависит от магнитуды):**
```
K = 10^(α × (M - Mc))
```

где:
- α ≈ 0.8 (параметр продуктивности)
- M — магнитуда основного толчка
- Mc — cutoff магнитуда (Mc = target - 0.5)

**Итоговый boost:**
```
λ_etas = λ_base + Σ (productivity_i × omori_factor_i × calibration)

где сумма по всем событиям за последние 30 дней с M ≥ Mc
```

### 3. Лунный модификатор

Исследования показывают, что землетрясения ~15% вероятнее при сизигиях (новолуние/полнолуние) из-за приливных сил.

**Расчёт:**
```
phase = moon.phase / 100  # 0 = новолуние, 0.5 = полнолуние

# cos(4π × phase) = 1 при сизигиях, -1 при квадратурах
effect = cos(4π × phase) × 0.075  # ±7.5%

modifier = 1.0 + effect
```

**Для длинных периодов (> 1 года):**
Эффект усредняется до ~1.0, поэтому модификатор не применяется.

### 4. Интеграция компонентов

```
1. Получаем posterior параметры из Bayesian update:
   α_post = α_prior + observed_count
   β_post = β_prior + observed_years

2. Вычисляем ETAS boost:
   etas_λ = Σ (K_i / (t_i + c)^p)

3. Вычисляем лунный модификатор:
   lunar_mod = average(modifier) по периоду

4. Корректируем параметры:
   effective_β = β_post / (1 + etas_λ/λ_mean) / lunar_mod

5. Вычисляем вероятность через Negative Binomial:
   P(X ∈ [min, max]) = NegBinom.cdf(max, r, p) - NegBinom.cdf(min-1, r, p)

   где r = α_post, p = effective_β / (effective_β + remaining_years)
```

## Использование

### Базовый запуск
```bash
python main_integrated.py
```

### Сравнение с простой моделью
```bash
python main_integrated.py --compare
```

### Отключение компонентов
```bash
# Только Bayesian (без ETAS и лунного)
python main_integrated.py --no-etas --no-lunar

# Простой Пуассон с ETAS
python main_integrated.py --no-bayesian --no-lunar

# Полная модель
python main_integrated.py
```

### Режимы торговли
```bash
# Анализ (без торговли)
python main_integrated.py

# Отладка (подтверждение каждой сделки)
python main_integrated.py --debug --bankroll 500

# Автоматическая торговля
python main_integrated.py --auto --bankroll 1000
```

## Зависимости

**Обязательные:**
- Python 3.9+
- httpx
- (все зависимости из main.py)

**Опциональные:**
- `scipy` — для точного расчёта Negative Binomial (fallback реализован)
- `ephem` — для лунных фаз (без него лунный модификатор отключён)

Установка опциональных зависимостей:
```bash
pip install scipy ephem
```

## Примеры вывода

### Сравнение моделей

```
1. https://polymarket.com/event/how-many-7pt0-or-above-earthquakes-by-june-30
   BUY YES на '8+'
   Интегр: 35.2%  |  Рынок: 28.0%  |  Edge: +7.2%
   Простая: 32.1%  |  Simple Edge: +4.1%  |  Δ модели: +3.1%
   Выигрыш: 35.2%  |  Проигрыш: 64.8%  |  Дней: 177
   ROI: +25.7%  |  APY: +53%
```

**Интерпретация:**
- Интегрированная модель даёт 35.2% (vs 32.1% простой)
- Дополнительный edge +3.1% от улучшений модели
- При рыночной цене 28% — edge составляет +7.2%

## Исторические данные

Модель использует данные M7.0+ землетрясений за 1900-2024:

```python
# Примеры по годам:
2010: 23  # Максимум (Чили M8.8, Гаити M7.0, и др.)
2017: 7   # Минимум
2023: 18
2024: 14
```

**Статистика:**
- Среднее: 14.5/год
- Стандартное отклонение: 2.9
- Диапазон: 7-23

## Обработка разных магнитуд

| Магнитуда | Bayesian | Данные | Примечание |
|-----------|----------|--------|------------|
| M7.0+ | ВКЛ | 1900-2024 (124 года) | Полные исторические данные |
| M8.0+ | ВКЛ | 2000-2024 (25 лет) | Отдельные данные M8+ |
| M9.0+ | ВЫКЛ | Табличная частота | Слишком редкие для Bayesian |
| M10.0+ | ВЫКЛ | Табличная частота | Никогда не было |

**M8.0+ статистика (2000-2024):**
- Среднее: ~1.08/год
- Диапазон: 0-4 в год
- Всего: 27 событий за 25 лет

**M9.0+ статистика (1900-2024):**
- Всего 5 событий за 124 года
- Частота: ~0.04/год (1 за 25 лет)

## Ограничения

1. **ETAS-коррекция** — грубое приближение, не полная ETAS-модель
2. **Лунный эффект** — статистически слабый (~15%), может быть шумом
3. **Региональная независимость** — модель не учитывает региональные особенности
4. **Временная стационарность** — предполагается постоянная базовая частота
5. **M9.0+/M10.0+** — Bayesian отключён из-за недостатка данных

## Научные источники

1. **ETAS модель:**
   - Ogata, Y. (1988). Statistical models for earthquake occurrences
   - [Bayesian ETAS (2024)](https://earth-planets-space.springeropen.com/articles/10.1186/s40623-024-02021-8)

2. **Приливное влияние:**
   - [Scientific American (2024)](https://www.scientificamerican.com/article/can-astronomical-tidal-forces-trigger-earthquakes/)
   - USGS FAQ on tidal triggering

3. **Gamma-Poisson:**
   - Gelman et al. Bayesian Data Analysis

## Файлы

- `main.py` — базовая модель (простой Пуассон)
- `main_integrated.py` — интегрированная модель (Bayesian + ETAS + Lunar)
- `main_consensus.py` — **консенсусная модель** (рекомендуется)
- `docs/integrated_model.md` — эта документация

---

## Консенсусная модель (main_consensus.py)

**Рекомендуемый способ использования** — объединяет обе модели с правилами:

### Правила консенсуса

| Магнитуда | Правило | Основа |
|-----------|---------|--------|
| **M7.0+** | Показываем всегда | Интегрированная (основная), простая для справки |
| **M8.0+** | Только при согласии | Если модели на одной стороне (обе YES или обе NO) |
| **DISAGREE** | Скрываем | Модели на разных сторонах → не ставим |

### Уровни уверенности

| Консенсус | Confidence | Описание |
|-----------|------------|----------|
| AGREE | HIGH | Модели согласны, разница < 3% |
| AGREE | MEDIUM | Модели согласны, разница 3-7% |
| AGREE | LOW | Модели согласны, разница > 7% |
| WEAK | * | Только одна модель видит edge |
| DISAGREE | LOW | Модели на разных сторонах |

### Использование

```bash
# Стандартный запуск (скрывает расхождения)
python main_consensus.py

# Показать все, включая расхождения
python main_consensus.py --show-all

# Торговля
python main_consensus.py --debug --bankroll 500
python main_consensus.py --auto --bankroll 1000
```

### Пример вывода

```
1. https://polymarket.com/event/how-many-7pt0-or-above-earthquakes-in-2026
   [AGREE] +++ | M7.0+
   BUY YES на '8-10'
   Основная (интегр.): 16.6%  |  Edge: +4.6%
   Справка (простая):  10.8%  |  Edge: -1.2%
   Рынок: 12.0%  |  Дней: 360
   ROI: +38.6%  |  APY: +39%

Показано 4 возможностей с консенсусом
Скрыто 2 возможностей с расхождением моделей
```

### Аллокация с учётом confidence

При распределении банкролла учитывается confidence:
- HIGH: ×1.5 к score
- MEDIUM: ×1.0
- LOW: ×0.5

## Changelog

### v1.1.0 (2026-01-05)
- **НОВОЕ:** Консенсусная модель (`main_consensus.py`)
  - Объединяет простую и интегрированную модели
  - M7.0+: интегрированная как основная, простая для справки
  - M8.0+: только при согласии моделей
  - Уровни уверенности: HIGH/MEDIUM/LOW
  - Флаг `--show-all` для показа всех возможностей

### v1.0.1 (2026-01-05)
- **ИСПРАВЛЕН БАГ:** Модель использовала данные M7.0+ для всех магнитуд
  - Это завышало оценки M8.0+ в 2-3 раза!
- Добавлены отдельные исторические данные M8.0+ (2000-2024)
- Bayesian отключён для M9.0+/M10.0+ (слишком редкие события)
- Исправлено отображение статуса компонентов при отсутствии библиотек

### v1.0.0 (2026-01-04)
- Начальная реализация интегрированной модели
- Bayesian Poisson с Gamma prior
- ETAS-коррекция на основе недавних M6+ событий
- Лунный модификатор (ephem)
- Исторические данные M7.0+ за 1900-2024
- Сравнение с простой моделью в выводе
