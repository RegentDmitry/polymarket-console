# Критика Smart Money v2 — Проблемы и направления улучшения

*2026-02-10. Критический разбор текущего подхода для планирования бэктестов.*

См. описание метода: [smart_money_guide.md](smart_money_guide.md)

---

## 1. Проблемы с данными

### 1a. API лимит 200 позиций
**Критичность: ВЫСОКАЯ**

Polymarket Data API возвращает максимум 200 открытых и 200 закрытых позиций на трейдера. Трейдеры с 600+ ставками имеют искажённый profit/volume/ROI.

- `total_profit` может быть как завышен так и занижен (зависит от того, какие 200 позиций вернулись)
- `total_volume` занижен → ROI завышен
- Мы не можем даже оценить масштаб ошибки без полных данных

**Решение:** Dune Analytics — полные on-chain данные по каждому кошельку. Можно посчитать точный P&L из всех OrderFilled событий CTF Exchange контракта.

### 1b. Нет временных данных
**Критичность: ВЫСОКАЯ**

API не показывает КОГДА трейдер открыл позицию. Два трейдера с одинаковой позицией YES на $120k:
- Трейдер A: купил 3 месяца назад по 15¢ (имел инсайт/анализ)
- Трейдер B: купил вчера по 22¢ (FOMO или momentum)

Мы взвешиваем их одинаково, хотя информационная ценность разная. Ранний вход — сильнее сигнал.

**Решение:** On-chain timestamp из Dune позволит добавить time-weighted conviction.

### 1c. Выживший bias в выборке холдеров
**Критичность: СРЕДНЯЯ**

Мы берём ТОП-30 текущих холдеров. Это selection bias:
- Трейдер который купил YES по 10¢ и продал по 20¢ (удвоение) — НЕ ПОПАДАЕТ в выборку (его нет в холдерах)
- Трейдер который купил YES по 20¢ и держит убыточную позицию — ПОПАДАЕТ

Мы видим только тех кто СЕЙЧАС держит, а не тех кто принял лучшие решения.

**Решение:** Анализировать всех кто КОГДА-ЛИБО торговал на этом рынке (через on-chain историю), а не только текущих холдеров.

---

## 2. Проблемы формулы весов

### 2a. Health penalty пропускает double-negative трейдеров
**Критичность: СРЕДНЯЯ**

Текущее условие:
```python
if stats.unrealized_pnl < 0 and stats.realized_pnl > 0:
    health = max(0.2, 1.0 + stats.unrealized_pnl / (abs(stats.realized_pnl) + 1))
```

Трейдер с `realized = -$50k` и `unrealized = -$80k` получает health = 1.0 (нет штрафа), потому что `realized > 0` не выполняется. Это самый плохой трейдер, но он получает полный вес.

**Исправление:** убрать условие `realized > 0`, или использовать `abs(realized)` в знаменателе без проверки знака:
```python
if stats.unrealized_pnl < 0:
    health = max(0.2, 1.0 + stats.unrealized_pnl / (abs(stats.realized_pnl) + abs(stats.unrealized_pnl) + 1))
```

### 2b. Conviction может быть обманчив
**Критичность: СРЕДНЯЯ**

`conviction = position_value / portfolio_value` — доля портфеля в этой ставке. Но:
- Если трейдер имеет только 2 позиции, каждая получает conviction ~0.5 автоматически
- Если у трейдера 200 позиций, каждая получает ~0.005
- Диверсифицированный портфель штрафуется, хотя это может быть признак sophistication

### 2c. Profile bonus — грубая эвристика
**Критичность: НИЗКАЯ**

Категоризация по ключевым словам в названиях рынков работает примитивно:
- "Will Bitcoin mining be banned?" классифицируется как crypto, но это regulatory/politics
- Трейдер с 60% crypto рынков может быть просто degenerate, а не crypto expert
- Бонус ×1.5 выбран произвольно, не обоснован данными

---

## 3. Структурные проблемы

### 3a. Нет бэктеста — неизвестно, работает ли вообще
**Критичность: КРИТИЧЕСКАЯ**

Самая главная проблема: мы не знаем, генерирует ли SM flow alpha. Возможные исходы бэктеста:
- SM сигнал — noise (не лучше рандома)
- SM сигнал — lagging indicator (следует за ценой, а не предсказывает)
- SM сигнал — contrarian indicator (надо делать наоборот)
- SM сигнал — работает только на определённых рынках/объёмах

**План бэктеста:**
1. Собрать исторические SM сигналы (flow + implied) для N резолвившихся рынков
2. Сравнить с финальными исходами
3. Посчитать: `accuracy`, `Brier score`, `calibration`, `profit если ставить по SM`
4. Сравнить с наивными стратегиями (follow price, always NO, random)

### 3b. Circular reasoning risk
**Критичность: СРЕДНЯЯ**

Топ-холдеры определяются по SIZE позиции. Крупные позиции двигают цену. Мы по сути спрашиваем: "в какую сторону двигается цена?" — и выдаём это за "мнение smart money".

Это НЕ то же самое что "независимый сигнал": если 5 китов купили YES на $500k каждый, цена уже отражает их мнение. SM implied ≈ текущая цена → edge ≈ 0 всегда. Полезен только если SM implied РАСХОДИТСЯ с ценой.

### 3c. Кросс-рыночная консистентность не проверяется
**Критичность: СРЕДНЯЯ**

Для связанных рынков (BTC >$100k / >$120k / >$150k) должно выполняться:
```
P(>$100k) ≥ P(>$120k) ≥ P(>$150k)
```

SM implied может нарушать это из-за разных наборов холдеров. Мы поймали это вручную (v1 давал SM implied $100k = 12%, $120k = 47%), но автоматической проверки нет.

**Решение:** пост-обработка — если SM implied для >$120k > SM implied для >$100k, применить isotonic regression или просто взять max вниз по цепочке.

### 3d. Не учитываются hedge/arb позиции
**Критичность: СРЕДНЯЯ**

Трейдер может держать:
- YES $120k + NO $100k → это spread bet, не направленная ставка
- YES Feb + NO Annual → календарный спред

Мы интерпретируем каждую ногу отдельно, хотя они взаимозависимы. Один трейдер может считаться "smart on YES" на одном рынке и "smart on NO" на связанном.

---

## 4. Концептуальные ограничения

### 4a. "Past performance ≠ future results" — не cliche, а проблема
Profit-based weighting предполагает что прибыльные трейдеры ПРОДОЛЖАТ быть прибыльными. Но:
- В prediction markets P&L во многом определяется несколькими крупными ставками
- Рынок crypto vs politics vs geopolitics — разные скиллы
- "Лучший crypto трейдер" может не понимать Iran geopolitics

### 4b. Информация уже в цене
Если smart money уже купили — их мнение отражено в текущей цене. Edge существует только если:
- SM ещё не полностью вложились (будут покупать ещё)
- Рынок неликвидный и SM ≠ marginal price setter
- Другие участники не видят SM позиции (но они публичны на Polymarket!)

---

## 5. Приоритеты для бэктеста

### Фаза 1: Валидация базового сигнала
1. Собрать данные по 100+ резолвившимся рынкам (Dune + API)
2. Для каждого: SM flow на момент T-7d, T-3d, T-1d до резолюции
3. Сравнить SM implied vs actual outcome
4. Метрики: accuracy, Brier score, calibration curve
5. Null hypothesis: SM flow = noise

### Фаза 2: Оптимизация формулы (только если Фаза 1 показала alpha)
1. A/B тест компонентов: log vs linear, с/без health, с/без conviction
2. Оптимизация shrinkage_k, max_weight_share через cross-validation
3. Тест time-weighted conviction (если есть on-chain timestamps)

### Фаза 3: Продвинутые фичи
1. Кросс-рыночная консистентность (isotonic regression)
2. Детекция hedge/arb позиций
3. Temporal signal (rate of change SM flow)
4. Market-type specific weights (crypto vs politics)

---

## 6. Данные для бэктеста — что нужно из Dune

### Минимальный набор (бесплатный Dune)
```sql
-- Все сделки конкретного трейдера на CTF Exchange
SELECT block_time, maker, taker, tokenID, makerAmount, takerAmount
FROM polygon.transactions
WHERE to = '0x4bfb41d5b3570defd03c39a9a4d8de6bd8b8982e'  -- CTF Exchange
AND (maker = '{wallet}' OR taker = '{wallet}')
```

### Полный набор (для бэктеста SM сигнала)
1. **Все трейдеры на рынке X** — кто торговал, когда, по какой цене
2. **P&L каждого трейдера** — точный, из on-chain данных (не API приближение)
3. **Исторические цены рынков** — для расчёта SM implied в прошлом
4. **Исходы рынков** — для оценки accuracy

### Ключевые таблицы Dune для Polymarket
- `polymarket.trades` — все сделки на CLOB
- `erc1155_polygon.evt_TransferSingle` — CTF token transfers
- `polygon.transactions` — raw tx data

---

*Этот документ — план для систематической оценки и улучшения SM анализа. Следующий шаг: бэктест Фаза 1.*
