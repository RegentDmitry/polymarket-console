# Smart Money Analyzer — Логика и параметры (v2)

## Что это

Скрипт `crypto/smart_money.py` анализирует крупнейших холдеров любого рынка на Polymarket и оценивает, на какой стороне (YES/NO) стоят исторически прибыльные трейдеры.

## Использование

```bash
# Анализ всего события
python crypto/smart_money.py what-price-will-bitcoin-hit-before-2027

# Фильтр по конкретному рынку
python crypto/smart_money.py what-price-will-bitcoin-hit-before-2027 --market "120,000"

# URL тоже работает
python crypto/smart_money.py https://polymarket.com/event/bitcoin-best-month-in-2026

# Параметры
--market, -m    Фильтр по подстроке в названии рынка
--top, -t       Количество холдеров на сторону (по умолчанию 30)
--no-cache      Игнорировать кеш (перезагрузить все данные)
```

## Алгоритм

### 1. Сбор данных

```
Slug/URL → Gamma API (события + рынки)
        → Data API /holders (топ холдеры YES и NO)
        → Data API /positions + /closed-positions (статистика каждого трейдера)
```

### 2. Расчёт веса трейдера (v2 — conviction-weighted с log-scale)

Для каждого холдера рассчитывается **вес**:

```
weight = log_profit × roi_mult × health × conviction × shrinkage × profile_bonus
```

Где:

| Компонент | Формула | Что измеряет |
|-----------|---------|-------------|
| **log_profit** | sign(profit) × log(1 + \|profit\|) | Скилл, сжатый логарифмом — outliers не доминируют |
| **roi_mult** | 1.0 + clamp(ROI, -0.5, 2.0) | Награда за скилл (ROI), не за размер кошелька. Диапазон 0.5× — 3.0× |
| **health** | max(0.2, 1 + unrealized / (\|realized\| + 1)) | Штраф за unrealized losses. Трейдер с плохими текущими позициями получает пенальти |
| **conviction** | position_value / portfolio_value | Уверенность: какую долю портфеля вложил в эту ставку |
| **shrinkage** | n_trades / (n_trades + 30) | Доверие: фильтрует лакеров с малым числом сделок |
| **profile_bonus** | 1.0 + crypto_share × 0.5 | Профильность: +50% бонус для crypto-трейдеров на crypto-рынках |

### 2b. Кап на долю одного трейдера

После расчёта весов всех холдеров, ни один трейдер не может составлять более **15%** от суммарного абсолютного веса. Это предотвращает ситуацию, когда один outlier перекашивает весь сигнал.

### 3. Агрегация

**Smart Money Flow** — от -1 (все умные на NO) до +1 (все на YES):

```
flow = Σ(weight × side) / Σ(|weight|)
```

где side = +1 для YES, -1 для NO.

**Smart Implied** — подразумеваемая вероятность YES:

```
implied = yes_weight / (yes_weight + no_weight)
```

### 4. Интерпретация

| Flow | Сигнал |
|------|--------|
| > +0.3 | STRONG YES |
| +0.1 ... +0.3 | YES |
| -0.1 ... +0.1 | NEUTRAL |
| -0.3 ... -0.1 | NO |
| < -0.3 | STRONG NO |

**Edge = Smart Implied - PM Price**

Если edge > 0 → smart money считает YES недооценённым.
Если edge < 0 → smart money считает YES переоценённым (ставить NO).

## Параметры модели

| Параметр | Значение | Описание |
|----------|----------|----------|
| HOLDER_LIMIT | 30 | Топ холдеров на каждую сторону (YES/NO) |
| SHRINKAGE_K | 30 | Байесовский порог: при 30 сделках shrinkage = 0.5 |
| MAX_WEIGHT_SHARE | 0.15 | Макс. доля одного трейдера в сигнале (15%) |
| CACHE_TTL | 3600 сек | Время жизни кеша трейдеров (1 час) |
| profile_bonus | ×1.5 max | Бонус для профильных трейдеров (>30% crypto) |

## Изменения v1 → v2 (2026-02-10)

### Проблемы v1
1. **Линейный profit** — один трейдер с $7M профитом доминировал весь сигнал (вес 6,000,000+)
2. **API лимит 200 позиций** — у трейдеров с 600+ ставками profit не соответствовал реальности
3. **Нет капа** — Athletic-Screwup (back-in-whack, P&L -$135k) имел вес +55,840 на рынке BTC >$100k
4. **Volume только из open** — ROI считался неточно (деление на заниженный volume)
5. **Unrealized losses игнорировались** — трейдер deep underwater считался "smart"

### Исправления v2
1. **Log-scale profit**: $100 → 4.6, $10k → 9.2, $1M → 13.8 (вместо линейного)
2. **ROI multiplier**: награда за скилл (×0.5 — ×3.0), а не за размер кошелька
3. **Health penalty**: штраф за большие unrealized losses (×0.2 — ×1.0)
4. **Weight cap 15%**: ни один трейдер не может дать >15% сигнала
5. **Volume из closed**: `totalBought` теперь суммируется и для закрытых позиций

### Результат на BTC >$100k
```
                  v1              v2
Edge:            -36.6%          -3.4%
Smart Implied:   12%             45%
Athletic-Screwup вес: +55,840   +3
```
Ложный "огромный edge" исчез. Сигнал стал реалистичным.

## Категоризация трейдеров

Скрипт определяет профиль трейдера по названиям его рынков:

| Ключевые слова | Категория |
|---------------|-----------|
| bitcoin, btc, ethereum, crypto | crypto |
| trump, biden, election | politics |
| earthquake, weather, climate | science |
| nfl, nba, super bowl | sports |
| fed, inflation, gdp | economics |

**crypto_share** = доля crypto-рынков в портфеле трейдера. На crypto-рынках трейдеры с высоким crypto_share получают бонус к весу.

## Ограничения

1. **API лимит 200 позиций** — для трейдеров с 200+ ставками profit может не совпадать с профилем на сайте
2. **Past performance** — прибыльность в прошлом не гарантирует будущего
3. **Маленькие рынки** — при объёме <$500k мало холдеров, сигнал шумный
4. **Нет данных о времени входа** — не знаем когда трейдер купил (мог войти по другой цене)
5. **Противоречивые позиции** — трейдер может держать YES на $120k и NO на $100k (арбитраж/спред), что не ловится автоматически

### Как верифицировать SM сигнал
- Проверяй **логическую консистентность** между связанными рынками (BTC >$100k / >$120k / >$150k)
- Открывай профили крупнейших холдеров по ссылке `https://polymarket.com/profile/{proxyWallet}`
- Если SM implied на $120k выше чем на $100k — сигнал по $100k артефактный

## Кеширование

Статистика трейдеров кешируется в `/tmp/pm_trader_cache.json` на 1 час. При повторном запуске используются кешированные данные (ускоряет в ~10 раз). Для свежих данных: `--no-cache`.
